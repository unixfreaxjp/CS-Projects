akshay@ubuntu:~/cs3013/project1$ ./shell2 < shell2_test
==>INPUT:sleep 10s &

==>INPUT:firefox &

==>INPUT:ps -ef

UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 18:51 ?        00:00:00 /sbin/init
root         2     0  0 18:51 ?        00:00:00 [kthreadd]
root         3     2  0 18:51 ?        00:00:00 [ksoftirqd/0]
root         5     2  0 18:51 ?        00:00:00 [kworker/u:0]
root         6     2  0 18:51 ?        00:00:00 [migration/0]
root         7     2  0 18:51 ?        00:00:00 [watchdog/0]
root         8     2  0 18:51 ?        00:00:00 [migration/1]
root        10     2  0 18:51 ?        00:00:00 [ksoftirqd/1]
root        11     2  0 18:51 ?        00:00:00 [kworker/0:1]
root        12     2  0 18:51 ?        00:00:00 [watchdog/1]
root        13     2  0 18:51 ?        00:00:00 [migration/2]
root        15     2  0 18:51 ?        00:00:00 [ksoftirqd/2]
root        16     2  0 18:51 ?        00:00:00 [watchdog/2]
root        17     2  0 18:51 ?        00:00:00 [cpuset]
root        18     2  0 18:51 ?        00:00:00 [khelper]
root        19     2  0 18:51 ?        00:00:00 [kdevtmpfs]
root        20     2  0 18:51 ?        00:00:00 [netns]
root        21     2  0 18:51 ?        00:00:00 [kworker/u:1]
root        22     2  0 18:51 ?        00:00:00 [sync_supers]
root        23     2  0 18:51 ?        00:00:00 [bdi-default]
root        24     2  0 18:51 ?        00:00:00 [kintegrityd]
root        25     2  0 18:51 ?        00:00:00 [kblockd]
root        26     2  0 18:51 ?        00:00:00 [ata_sff]
root        27     2  0 18:51 ?        00:00:00 [khubd]
root        28     2  0 18:51 ?        00:00:00 [md]
root        30     2  0 18:51 ?        00:00:00 [khungtaskd]
root        31     2  0 18:51 ?        00:00:00 [kswapd0]
root        32     2  0 18:51 ?        00:00:00 [ksmd]
root        33     2  0 18:51 ?        00:00:00 [khugepaged]
root        34     2  0 18:51 ?        00:00:00 [fsnotify_mark]
root        35     2  0 18:51 ?        00:00:00 [ecryptfs-kthrea]
root        36     2  0 18:51 ?        00:00:00 [crypto]
root        47     2  0 18:51 ?        00:00:00 [kthrotld]
root        48     2  0 18:51 ?        00:00:00 [kworker/1:1]
root        49     2  0 18:51 ?        00:00:00 [scsi_eh_0]
root        50     2  0 18:51 ?        00:00:00 [scsi_eh_1]
root        71     2  0 18:51 ?        00:00:00 [devfreq_wq]
root        73     2  0 18:51 ?        00:00:00 [kworker/1:2]
root       184     2  0 18:51 ?        00:00:00 [mpt_poll_0]
root       192     2  0 18:51 ?        00:00:00 [mpt/0]
root       239     2  0 18:51 ?        00:00:00 [scsi_eh_2]
root       257     2  0 18:51 ?        00:00:01 [jbd2/sda1-8]
root       258     2  0 18:51 ?        00:00:00 [ext4-dio-unwrit]
root       348     1  0 18:51 ?        00:00:00 upstart-udev-bridge --daemon
root       350     1  0 18:51 ?        00:00:00 /sbin/udevd --daemon
root       419     2  0 18:51 ?        00:00:00 [ttm_swap]
root       487   350  0 18:51 ?        00:00:00 /sbin/udevd --daemon
root       536     2  0 18:51 ?        00:00:00 [kpsmoused]
root       597     1  0 18:51 ?        00:00:00 upstart-socket-bridge --daemon
102        715     1  0 18:51 ?        00:00:00 dbus-daemon --system --fork --activation=upstart
root       737     1  0 18:51 ?        00:00:00 /usr/sbin/modem-manager
syslog     763     1  0 18:51 ?        00:00:01 rsyslogd -c5
root       764     1  0 18:51 ?        00:00:00 NetworkManager
root       772     1  0 18:51 ?        00:00:00 /usr/sbin/cupsd -F
avahi      808     1  0 18:51 ?        00:00:00 avahi-daemon: running [ubuntu.local]
avahi      809   808  0 18:51 ?        00:00:00 avahi-daemon: chroot helper
root       814     1  0 18:51 ?        00:00:00 /usr/lib/policykit-1/polkitd --no-debug
colord     831     1  0 18:51 ?        00:00:00 /usr/lib/i386-linux-gnu/colord/colord
root       838   764  0 18:51 ?        00:00:00 /sbin/dhclient -d -4 -sf /usr/lib/NetworkManager/nm-dhcp-client.action -pf /var/run/sendsigs.omit.d/network-manager.dhclient-eth0.p
root       874     1  0 18:51 tty4     00:00:00 /sbin/getty -8 38400 tty4
root       917     1  0 18:51 tty5     00:00:00 /sbin/getty -8 38400 tty5
root       923     1  0 18:51 tty2     00:00:00 /sbin/getty -8 38400 tty2
root       924     1  0 18:51 tty3     00:00:00 /sbin/getty -8 38400 tty3
root       926     1  0 18:51 tty6     00:00:00 /sbin/getty -8 38400 tty6
root       931     1  0 18:51 ?        00:00:00 acpid -c /etc/acpi/events -s /var/run/acpid.socket
root       935     1  0 18:51 ?        00:00:00 lightdm
root       937     1  0 18:51 ?        00:00:00 /usr/sbin/irqbalance
root       938     1  0 18:51 ?        00:00:00 cron
daemon     939     1  0 18:51 ?        00:00:00 atd
whoopsie   942     1  0 18:51 ?        00:00:00 whoopsie
root      1183     1  0 18:51 tty1     00:00:00 /sbin/getty -8 38400 tty1
root      1220     1  0 18:51 ?        00:00:00 /usr/lib/accountsservice/accounts-daemon
root      1284     1  0 18:51 ?        00:00:00 /usr/sbin/console-kit-daemon --no-daemon
root      1800     1  0 18:51 ?        00:00:00 /usr/lib/upower/upowerd
root      1883     1  0 18:51 ?        00:00:00 /usr/sbin/vmware-vmblock-fuse -o subtype=vmware-vmblock,default_permissions,allow_other /var/run/vmblock-fuse
root      2036     1  0 18:51 ?        00:00:08 /usr/sbin/vmtoolsd
rtkit     2073     1  0 18:51 ?        00:00:00 /usr/lib/rtkit/rtkit-daemon
root      2076     1  0 18:51 ?        00:00:00 tpvmlpd2
nobody    2111   764  0 18:51 ?        00:00:00 /usr/sbin/dnsmasq --no-resolv --keep-in-foreground --no-hosts --bind-interfaces --pid-file=/var/run/sendsigs.omit.d/network-manager
root      2286     1  0 18:51 ?        00:00:00 /usr/lib/udisks/udisks-daemon
root      2287  2286  0 18:51 ?        00:00:00 udisks-daemon: not polling any devices
root      4302     2  0 21:11 ?        00:00:00 [flush-8:0]
root      4791   935  2 21:33 tty7     00:00:49 /usr/bin/X :0 -auth /var/run/lightdm/root/:0 -nolisten tcp vt7 -novtswitch
root      4792     2  0 21:33 ?        00:00:00 [kworker/0:2]
root      4884   935  0 21:33 ?        00:00:00 [lightdm] <defunct>
root      4937   935  0 21:33 ?        00:00:00 lightdm --session-child 12 23
akshay    4973     1  0 21:33 ?        00:00:00 /usr/bin/gnome-keyring-daemon --daemonize --login
akshay    4984  4937  0 21:33 ?        00:00:00 gnome-session --session=ubuntu
akshay    5019  4984  0 21:33 ?        00:00:00 /usr/bin/ssh-agent /usr/bin/dbus-launch --exit-with-session gnome-session --session=ubuntu
akshay    5022     1  0 21:33 ?        00:00:00 /usr/bin/dbus-launch --exit-with-session gnome-session --session=ubuntu
akshay    5023     1  0 21:33 ?        00:00:01 //bin/dbus-daemon --fork --print-pid 5 --print-address 7 --session
akshay    5031  4984  0 21:33 ?        00:00:00 /usr/lib/gnome-settings-daemon/gnome-settings-daemon
akshay    5042     1  0 21:33 ?        00:00:00 /usr/lib/gvfs/gvfsd
akshay    5044     1  0 21:33 ?        00:00:00 /usr/lib/gvfs//gvfs-fuse-daemon -f /home/akshay/.gvfs
akshay    5051  4984  3 21:33 ?        00:01:01 compiz
akshay    5054     1  0 21:33 ?        00:00:00 /usr/lib/i386-linux-gnu/gconf/gconfd-2
akshay    5060  4984  0 21:33 ?        00:00:04 nautilus -n
akshay    5061  4984  0 21:33 ?        00:00:00 bluetooth-applet
akshay    5062  4984  0 21:33 ?        00:00:00 nm-applet
akshay    5065  4984  0 21:33 ?        00:00:00 /usr/lib/gnome-settings-daemon/gnome-fallback-mount-helper
akshay    5069  4984  0 21:33 ?        00:00:00 /usr/lib/policykit-1-gnome/polkit-gnome-authentication-agent-1
akshay    5075     1  0 21:33 ?        00:00:00 /usr/bin/pulseaudio --start --log-target=syslog
akshay    5077     1  0 21:33 ?        00:00:02 /usr/lib/vmware-tools/sbin32/vmtoolsd -n vmusr --blockFd 3
akshay    5086  5075  0 21:33 ?        00:00:00 /usr/lib/pulseaudio/pulse/gconf-helper
akshay    5093     1  0 21:33 ?        00:00:00 /usr/lib/gvfs/gvfs-gdu-volume-monitor
akshay    5100     1  0 21:33 ?        00:00:00 /usr/lib/gvfs/gvfs-gphoto2-volume-monitor
akshay    5102     1  0 21:33 ?        00:00:00 /usr/lib/gvfs/gvfs-afc-volume-monitor
akshay    5111     1  0 21:33 ?        00:00:00 /usr/lib/gvfs/gvfsd-trash --spawner :1.6 /org/gtk/gvfs/exec_spaw/0
akshay    5128     1  0 21:33 ?        00:00:01 /usr/lib/bamf/bamfdaemon
akshay    5153  5051  0 21:33 ?        00:00:00 /bin/sh -c /usr/bin/compiz-decorator
akshay    5154  5153  0 21:33 ?        00:00:00 /usr/bin/gtk-window-decorator
akshay    5161     1  0 21:33 ?        00:00:00 /usr/lib/gvfs/gvfsd-burn --spawner :1.6 /org/gtk/gvfs/exec_spaw/1
akshay    5167     1  0 21:33 ?        00:00:01 /usr/lib/indicator-appmenu/hud-service
akshay    5168     1  0 21:33 ?        00:00:02 /usr/lib/unity/unity-panel-service
akshay    5182     1  0 21:33 ?        00:00:00 /usr/lib/indicator-session/indicator-session-service
akshay    5187     1  0 21:33 ?        00:00:00 /usr/lib/indicator-application/indicator-application-service
akshay    5189     1  0 21:33 ?        00:00:00 /usr/lib/indicator-messages/indicator-messages-service
akshay    5193     1  0 21:33 ?        00:00:00 /usr/lib/indicator-sound/indicator-sound-service
akshay    5207     1  0 21:33 ?        00:00:00 /usr/lib/indicator-printers/indicator-printers-service
akshay    5213     1  0 21:33 ?        00:00:00 /usr/lib/indicator-datetime/indicator-datetime-service
akshay    5240     1  0 21:33 ?        00:00:00 /usr/lib/geoclue/geoclue-master
akshay    5245     1  0 21:33 ?        00:00:00 /usr/lib/ubuntu-geoip/ubuntu-geoip-provider
akshay    5258     1  0 21:33 ?        00:00:00 /usr/lib/unity-lens-applications/unity-applications-daemon
akshay    5261     1  0 21:33 ?        00:00:00 /usr/lib/unity-lens-music/unity-music-daemon
akshay    5263     1  0 21:33 ?        00:00:00 /usr/bin/python /usr/lib/unity-lens-video/unity-lens-video
akshay    5264     1  0 21:33 ?        00:00:00 /usr/lib/unity-lens-files/unity-files-daemon
akshay    5292     1  0 21:33 ?        00:00:00 /usr/bin/zeitgeist-daemon
akshay    5299     1  0 21:33 ?        00:00:00 /usr/lib/zeitgeist/zeitgeist-fts
akshay    5300     1  0 21:33 ?        00:00:00 zeitgeist-datahub
akshay    5306  5299  0 21:33 ?        00:00:00 /bin/cat
akshay    5319     1  0 21:33 ?        00:00:00 /usr/lib/unity-lens-music/unity-musicstore-daemon
akshay    5321     1  0 21:33 ?        00:00:00 /usr/bin/python /usr/lib/unity-scope-video-remote/unity-scope-video-remote
akshay    5408  4984  0 21:33 ?        00:00:00 /usr/lib/gnome-disk-utility/gdu-notification-daemon
akshay    5412  4984  0 21:33 ?        00:00:00 telepathy-indicator
akshay    5418     1  0 21:33 ?        00:00:00 /usr/lib/telepathy/mission-control-5
akshay    5423     1  0 21:33 ?        00:00:00 /usr/lib/gnome-online-accounts/goa-daemon
akshay    5448  4984  0 21:33 ?        00:00:00 gnome-screensaver
akshay    5458  4984  0 21:34 ?        00:00:00 update-notifier
akshay    5508  4984  0 21:35 ?        00:00:00 /usr/lib/deja-dup/deja-dup/deja-dup-monitor
root      5570   350  0 21:37 ?        00:00:00 /sbin/udevd --daemon
akshay    5639     1  0 21:40 ?        00:00:00 /usr/lib/dconf/dconf-service
akshay    5703     1  0 21:40 ?        00:00:01 evince /home/akshay/Documents/Project1_ForkShell.pdf
akshay    5710     1  0 21:40 ?        00:00:00 /usr/lib/evince/evinced
akshay    5722     1  0 21:40 ?        00:00:00 /usr/lib/gvfs/gvfsd-metadata
akshay    5748  5051  0 21:41 ?        00:00:00 /bin/sh -c gnome-terminal
akshay    5749  5748  0 21:41 ?        00:00:05 gnome-terminal
akshay    5753  5749  0 21:41 ?        00:00:00 gnome-pty-helper
akshay    5754  5749  0 21:41 pts/0    00:00:00 bash
akshay    5861     1  1 21:41 ?        00:00:14 gedit
akshay    6076     1  0 21:46 ?        00:00:00 /usr/lib/at-spi2-core/at-spi-bus-launcher
root      6291     2  0 21:51 ?        00:00:00 [kworker/2:2]
root      6487     2  0 21:56 ?        00:00:00 [kworker/2:0]
akshay    6643     1  0 22:00 ?        00:00:00 /usr/lib/notify-osd/notify-osd
root      6736     2  0 22:01 ?        00:00:00 [kworker/2:1]
akshay    6787  5754  0 22:03 pts/0    00:00:00 ./shell2
akshay    6788  6787  0 22:03 pts/0    00:00:00 ./shell2
akshay    6789  6787  0 22:03 pts/0    00:00:00 ./shell2
akshay    6790  6788  0 22:03 pts/0    00:00:00 sleep 10s
akshay    6791  6787  0 22:03 pts/0    00:00:00 ./shell2
akshay    6792  6791  0 22:03 pts/0    00:00:00 ps -ef
akshay    6793  6789  0 22:03 pts/0    00:00:00 /usr/lib/firefox/firefox

Stats for child 6792 (ps) :
	Elapsed time: 9ms
	User CPU time: 8ms
	System CPU time: 0ms
	Involuntary context switches: 324
	Voluntary context switches: 1
	Major page faults: 0
	Minor page faults: 375
==>INPUT:cat shell2.c

#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <wait.h>
#include <stdlib.h>
#include "runstat.h"

#define CMD_LEN 128
#define MAX_TOKENS 32

#define PROMPT "==>"
#define CMD_EXIT "exit"
#define CMD_CD "cd"
#define CMD_JOBS "jobs"
#define FLAG_BACKGROUND "&"

typedef struct bg_proc 
{
	int PID;
	char* cmd;
	struct bg_proc* next;
	struct bg_proc* prev;
} bg_proc_t ;

void remove_pid(bg_proc_t* first, bg_proc_t* last, int pid)
{
	bg_proc_t* p;
	p = first;

	while(p != NULL){
		if(p->PID == pid){
			if(p->prev != NULL) 
				p->prev->next = p->next;
			if(p->next != NULL)
				 p->next->prev = p->prev;
			if(p == first) 
				first = p->next;
			if(p == last)
				last = p->next;			
			break;			
		}
		p = p->next;						
	}
}

int main(int argc, char** argv)
{
	int exit = 0;
	char* input = NULL;

	size_t buflen = 0;
	ssize_t inputlen = 0;

	bg_proc_t* first = NULL;
	bg_proc_t* last = NULL;
	int bgcount = 0;

	while(!exit){
		printf(PROMPT);
		int background = 0;
		inputlen = getline(&input, &buflen, stdin);
		//printf("READ:%s", input);
		
		if(inputlen == -1){
			break;		
		} else if (inputlen > 128){
			printf("Command was too long (> 128 characters)");	
		} else {

			char* tokens[MAX_TOKENS];
			char* token = NULL;
			int tokencount = 0;
			printf("INPUT:%s\n", input);
			input = strtok(input, "\n"); //remove endline character using strtok
		
			while((token = strtok(input, " ")) != NULL) {
				input = NULL;
				if(tokencount > MAX_TOKENS){
					printf("Too many tokens in command (> 32 tokens)\n");
					break;				
				}	
						
				tokens[tokencount] = token;
				//printf("[%d] = %s\n", tokencount, token);
				tokencount++;
			}
			

			if(tokencount > 0 && strcmp(tokens[tokencount-1], FLAG_BACKGROUND) == 0){
				background = 1;
				tokens[tokencount-1] = '\0'; // remove the '&'			
			} else {	
				tokens[tokencount] = '\0';
			} 
			
			if(tokencount == 0)continue;

			if(strcmp(tokens[0], CMD_EXIT) == 0){
				exit = 1;
			} else if (strcmp(tokens[0], CMD_CD) == 0){
				int result = chdir(tokens[1]);
				if(result == -1){						
					printf("Invalid syntax for cd\n");
				}				
			} else if (strcmp(tokens[0], CMD_JOBS) == 0) { 
				bg_proc_t* p = first;
				int i = 0;
				while(p != NULL){
					i++;
					printf("[%d] %d %s\n", i, p->PID, p->cmd);
					p = p->next;
				}			
			} else {
				int childPID = fork();
				if(childPID < 0){
					printf("fork() failed");
				} else if(childPID == 0){
					runstat(tokens);
					return 0;//exit(0); // this branch is a child process, so exit
				} else {
					int result = 0;
					if(!background){
						waitpid(childPID, NULL, 0);
					} else {
						bgcount++;
						bg_proc_t* new_proc = (bg_proc_t*)malloc(sizeof(bg_proc_t));
						new_proc->PID = childPID;
						new_proc->cmd = tokens[0];
						if(last == NULL){
							last = new_proc;
							first = last;
						} else {
							last->next = new_proc;
							new_proc->prev = last;
							last = new_proc;
						}		
					}	
					
					int pid = -1;
					while((pid = wait3(NULL, WNOHANG, NULL)) > 0) {
						remove_pid(first, last, pid);
						bgcount--;
					}				
				}
			}
					
		}

		input = NULL;
	}
	
	if(bgcount > 0){
		printf("Waiting for %d incomplete task(s) before exiting.\n", bgcount);
		fflush(stdout);
		while(bgcount > 0){
			int pid; 
			pid = wait3(NULL, WNOHANG, NULL);
			if(pid > 0) {
				remove_pid(first, last, pid);
				bgcount--;
			}
		}
	}
	
	return 0;
}


Stats for child 6796 (cat) :
	Elapsed time: 3ms
	User CPU time: 0ms
	System CPU time: 0ms
	Involuntary context switches: 195
	Voluntary context switches: 2
	Major page faults: 0
	Minor page faults: 188
==>INPUT:jobs

[1] 6788 sleep
[2] 6789 firefox
==>INPUT:exit

Waiting for 2 incomplete task(s) before exiting.

Stats for child 6790 (sleep) :
	Elapsed time: 10001ms
	User CPU time: 0ms
	System CPU time: 0ms
	Involuntary context switches: 1
	Voluntary context switches: 2
	Major page faults: 0
	Minor page faults: 188

Stats for child 6793 (firefox) :
	Elapsed time: 15020ms
	User CPU time: 1876ms
	System CPU time: 2228ms
	Involuntary context switches: 3079
	Voluntary context switches: 12870
	Major page faults: 4
	Minor page faults: 51234

